<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel IA BDV - An√°lisis en Vivo</title>
  <style>
    body {
      background-color: #0f172a;
      color: #e2e8f0;
      font-family: "Segoe UI", Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #38bdf8;
      margin-bottom: 10px;
    }

    .section {
      max-width: 1000px;
      margin: 0 auto 18px auto;
    }

    .snapshotBox {
      background-color: #0b1220;
      border: 1px solid rgba(56,189,248,0.25);
      padding: 14px 16px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      white-space: pre;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      line-height: 1.3;
      overflow-x: auto;
    }

    .muted {
      opacity: 0.75;
      font-size: 12px;
      text-align: center;
      margin-top: 8px;
    }

    #analysis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-top: 18px;
    }

    .card {
      background-color: #1e293b;
      padding: 15px;
      border-radius: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.28);
      transition: transform 0.2s ease;
      border: 1px solid rgba(148,163,184,0.18);
    }
    .card:hover { transform: translateY(-4px); }

    .symbol {
      font-size: 18px;
      font-weight: 800;
      color: #38bdf8;
      margin-bottom: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .badge {
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(148,163,184,0.15);
      border: 1px solid rgba(148,163,184,0.25);
      font-weight: 800;
      letter-spacing: 0.3px;
    }

    .bullish { color: #22c55e; }
    .bearish { color: #ef4444; }
    .neutral { color: #eab308; }

    .row {
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin: 6px 0;
      font-size: 14px;
    }
    .row b { color:#e2e8f0; }

    .divider {
      height: 1px;
      background: rgba(148,163,184,0.16);
      margin: 10px 0;
    }

    .error {
      color: #fecaca;
      background: rgba(239,68,68,0.12);
      border: 1px solid rgba(239,68,68,0.25);
      padding: 10px 12px;
      border-radius: 10px;
      text-align:center;
      grid-column: 1 / -1;
    }

    .btnRow{
      display:flex;
      justify-content:center;
      gap:10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    button{
      cursor:pointer;
      border: 1px solid rgba(56,189,248,0.35);
      background: rgba(56,189,248,0.12);
      color:#e2e8f0;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 700;
    }
    button:hover{ background: rgba(56,189,248,0.18); }

    .pill {
      display:inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.25);
      background: rgba(148,163,184,0.12);
      font-size: 12px;
      font-weight: 700;
      opacity: 0.9;
    }
  </style>
</head>

<body>
  <h1>üìä Panel IA BDV ‚Äî Estado del Mercado</h1>

  <div class="section">
    <div id="snapshotBox" class="snapshotBox">Cargando snapshot...</div>
    <div class="muted">
      Snapshot (actualiza cada 15s) ‚Äî <span class="pill">si el mercado est√° cerrado, los quotes pueden estar est√°ticos</span>
    </div>

    <div class="btnRow">
      <button onclick="manualRun()">Forzar an√°lisis ahora</button>
      <button onclick="loadAll()">Refrescar todo</button>
    </div>
  </div>

  <div class="section">
    <div id="analysis">Cargando an√°lisis...</div>
    <div class="muted">An√°lisis (actualiza cada 60s)</div>
  </div>

  <script>
    function fmt(n) {
      if (n === null || n === undefined) return "‚Äî";
      const x = Number(n);
      if (Number.isNaN(x)) return String(n);
      return x.toFixed(2);
    }

    // Cache local del √∫ltimo snapshot para poder pintarlo en cada card
    let LAST_SNAPSHOT = null;   // { QQQ:{price,bid,ask,time}, ... }
    let LAST_SNAPSHOT_RAW = null;

    function pickSnap(symbol){
      if (!LAST_SNAPSHOT) return null;
      return LAST_SNAPSHOT[symbol] || null;
    }

    function biasClass(bias) {
      if (!bias) return "neutral";
      const b = String(bias).toLowerCase();
      if (b === "bullish") return "bullish";
      if (b === "bearish") return "bearish";
      return "neutral";
    }

    // -----------------------------
    // SNAPSHOT
    // -----------------------------
    async function loadSnapshot() {
      const box = document.getElementById("snapshotBox");
      try {
        const res = await fetch("/snapshot", { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const j = await res.json();
        LAST_SNAPSHOT_RAW = j;

        const d = j.data || {};
        LAST_SNAPSHOT = d;

        const qqq = d.QQQ || {};
        const spy = d.SPY || {};
        const nvda = d.NVDA || {};

        box.textContent =
          `QQQ  price: ${fmt(qqq.price)}  bid: ${fmt(qqq.bid)}  ask: ${fmt(qqq.ask)}\n` +
          `     time : ${qqq.time || "‚Äî"}\n\n` +
          `SPY  price: ${fmt(spy.price)}  bid: ${fmt(spy.bid)}  ask: ${fmt(spy.ask)}\n` +
          `     time : ${spy.time || "‚Äî"}\n\n` +
          `NVDA price: ${fmt(nvda.price)}  bid: ${fmt(nvda.bid)}  ask: ${fmt(nvda.ask)}\n` +
          `     time : ${nvda.time || "‚Äî"}`;
      } catch (e) {
        box.textContent = "Error leyendo /snapshot: " + e.message;
        LAST_SNAPSHOT = null;
        LAST_SNAPSHOT_RAW = null;
      }
    }

    // -----------------------------
    // ANALYSIS
    // -----------------------------
    async function runAnalysisBackend(){
      // Preferimos /analysis/run porque SI genera data (tu backend ya lo tiene).
      // Si no existe, cae a /analysis/sync.
      try {
        const r = await fetch("/analysis/run", { cache: "no-store" });
        if (r.ok) return r;
      } catch (e) {}
      // fallback
      return fetch("/analysis/sync", { cache: "no-store" });
    }

    async function loadAnalysis() {
      const container = document.getElementById("analysis");
      try {
        // 1) dispara an√°lisis real
        await runAnalysisBackend();

        // 2) lee el sync ya listo para UI
        const r2 = await fetch("/analysis/sync", { cache: "no-store" });
        if (!r2.ok) throw new Error("HTTP " + r2.status);
        const data = await r2.json();

        const items = data.synced || [];
        container.innerHTML = "";

        if (!items || items.length === 0) {
          container.innerHTML = `<div class="error">No hay datos de an√°lisis a√∫n. Pulsa ‚ÄúForzar an√°lisis ahora‚Äù.</div>`;
          return;
        }

        // Orden estable por s√≠mbolo
        items.sort((a,b) => String(a.symbol).localeCompare(String(b.symbol)));

        items.forEach((item) => {
          const sym = (item.symbol || "‚Äî").toUpperCase();
          const div = document.createElement("div");
          div.classList.add("card");

          const cls = biasClass(item.bias);
          const confPct = (item.confidence !== undefined && item.confidence !== null)
            ? (Number(item.confidence) * 100).toFixed(0) + "%"
            : "‚Äî";

          // Merge snapshot por s√≠mbolo
          const snap = pickSnap(sym) || {};
          const quotePrice = snap.price;
          const quoteBid   = snap.bid;
          const quoteAsk   = snap.ask;
          const quoteTime  = snap.time;

          div.innerHTML = `
            <div class="symbol">
              <span>${sym}</span>
              <span class="badge ${cls}">${(item.bias || "neutral").toUpperCase()}</span>
            </div>

            <div class="row"><span>üí∞ Precio (an√°lisis)</span><b>${fmt(item.price)}</b></div>
            <div class="row"><span>üìà EMA9 / EMA20</span><b>${fmt(item.ema9)} / ${fmt(item.ema20)}</b></div>
            <div class="row"><span>üìä RSI</span><b>${fmt(item.rsi)}</b></div>
            <div class="row"><span>üì¶ Vol ratio</span><b>${(item.volume_ratio ?? "‚Äî")}</b></div>
            <div class="row"><span>üîπ Confianza</span><b>${confPct}</b></div>

            <div class="divider"></div>

            <div class="row"><span>üßæ Quote (snapshot)</span><b>${fmt(quotePrice)}</b></div>
            <div class="row"><span>üü© Bid / Ask</span><b>${fmt(quoteBid)} / ${fmt(quoteAsk)}</b></div>

            <div class="muted" style="text-align:left;margin-top:10px;">
              ‚è± Quote time: ${quoteTime || "‚Äî"}<br/>
              ‚è± Analysis time: ${item.timestamp ? new Date(item.timestamp).toLocaleString() : "‚Äî"}
            </div>
          `;

          container.appendChild(div);
        });

      } catch (error) {
        console.error("Error cargando an√°lisis:", error);
        container.innerHTML = `<div class="error">Error al conectar con analysis: ${error.message}</div>`;
      }
    }

    async function manualRun(){
      await loadSnapshot();
      await loadAnalysis();
    }

    async function loadAll(){
      await loadSnapshot();
      await loadAnalysis();
    }

    // Arranque
    loadAll();

    // Snapshot cada 15s
    setInterval(loadSnapshot, 15000);

    // Analysis cada 60s
    setInterval(loadAnalysis, 60000);
  </script>
</body>
</html>
