name: BDV Cron (scan + monitor)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

concurrency:
  group: bdv-cron
  cancel-in-progress: true

jobs:
  bdv:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Ensure AUTO execution mode + log config (robust)
        shell: bash
        run: |
          set -euo pipefail

          echo "Checking config status..."
          curl -sS --retry 5 --retry-delay 2 --retry-all-errors --max-time 20 \
            -D /tmp/headers_status.txt \
            -o /tmp/body_status.txt \
            "${{ secrets.BDV_BASE_URL }}/config/status" \
            -H "accept: application/json" \
            -H "x-bdv-secret: ${{ secrets.BDV_AGENT_SECRET }}" \
            -w "\nHTTP %{http_code}\n"

          echo "---- body (status) ----"
          head -c 2000 /tmp/body_status.txt || true
          echo

          echo "Setting execution_mode=auto via querystring..."
          curl -sS --retry 5 --retry-delay 2 --retry-all-errors --max-time 20 \
            -D /tmp/headers_set.txt \
            -o /tmp/body_set.txt \
            -X POST "${{ secrets.BDV_BASE_URL }}/config/execution-mode?mode=auto" \
            -H "accept: application/json" \
            -H "x-bdv-secret: ${{ secrets.BDV_AGENT_SECRET }}" \
            -w "\nHTTP %{http_code}\n"

          echo "---- body (set) ----"
          head -c 2000 /tmp/body_set.txt || true
          echo

      - name: Scan + conditional monitor (skip if out of RTH)
        shell: bash
        run: |
          set -euo pipefail

          echo "Calling /agent/scan..."
          # NO usamos --fail-with-body aqu√≠ porque fuera de RTH puede devolver status yellow y eso NO debe romper.
          curl -sS --retry 5 --retry-delay 2 --retry-all-errors --max-time 20 \
            -o /tmp/body_scan.txt \
            "${{ secrets.BDV_BASE_URL }}/agent/scan?force_analysis=0" \
            -H "accept: application/json" \
            -H "x-bdv-secret: ${{ secrets.BDV_AGENT_SECRET }}" \
            -w "\nHTTP %{http_code}\n" || true

          echo "---- body (scan) ----"
          head -c 2000 /tmp/body_scan.txt || true
          echo

          # Parse JSON para leer in_rth y decidir
          IN_RTH="$(python3 - <<'PY'
import json
p="/tmp/body_scan.txt"
try:
    d=json.load(open(p))
    print("true" if d.get("in_rth") else "false")
except Exception:
    print("false")
PY
)"
          echo "in_rth=$IN_RTH"

          if [ "$IN_RTH" != "true" ]; then
            echo "Outside RTH -> skipping /monitor/tick (exit 0)"
            exit 0
          fi

          echo "In RTH -> calling /monitor/tick..."
          curl -sS --retry 5 --retry-delay 2 --retry-all-errors --max-time 20 \
            -o /tmp/body_tick.txt \
            "${{ secrets.BDV_BASE_URL }}/monitor/tick" \
            -H "accept: application/json" \
            -H "x-bdv-secret: ${{ secrets.BDV_AGENT_SECRET }}" \
            -w "\nHTTP %{http_code}\n"

          echo "---- body (tick) ----"
          head -c 2000 /tmp/body_tick.txt || true
          echo
