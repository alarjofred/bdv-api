name: BDV Cron (scan + monitor)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch: {}

jobs:
  bdv:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Ensure AUTO execution mode (querystring) + log config (robust)
        shell: bash
        run: |
          set -euo pipefail

          hit () {
            local label="$1"
            local method="$2"
            local url="$3"
            local out_headers="$4"
            local out_body="$5"
            local out_code="$6"

            echo "===== ${label} ====="
            echo "${method} ${url}"

            # Nota: --fail-with-body hace que curl salga !=0 en 4xx/5xx,
            # pero igual guardamos headers/body para debug.
            curl -sS --fail-with-body \
              --retry 5 --retry-delay 2 --retry-all-errors \
              --connect-timeout 5 --max-time 25 \
              -X "${method}" \
              -D "${out_headers}" \
              -o "${out_body}" \
              -H "accept: application/json" \
              -H "x-bdv-secret: ${{ secrets.BDV_AGENT_SECRET }}" \
              -w "%{http_code}" \
              "${url}" > "${out_code}"

            local code
            code="$(cat "${out_code}" || true)"
            echo "HTTP ${code}"

            echo "---- headers (${label}) ----"
            head -c 2000 "${out_headers}" || true
            echo
            echo "---- body (${label}) ----"
            head -c 2000 "${out_body}" || true
            echo

            # Safety: si por alguna razón curl no falló pero code != 200, cortamos aquí.
            if [[ "${code}" != "200" ]]; then
              echo "ERROR: ${label} returned HTTP ${code}"
              exit 1
            fi
          }

          BASE="${{ secrets.BDV_BASE_URL }}"

          hit "config status (before)" "GET"  "${BASE}/config/status" \
            "/tmp/headers_status.txt" "/tmp/body_status.txt" "/tmp/code_status.txt"

          hit "set exec_mode=auto (querystring)" "POST" "${BASE}/config/execution-mode?mode=auto" \
            "/tmp/headers_set.txt" "/tmp/body_set.txt" "/tmp/code_set.txt"

          hit "config status (after)" "GET" "${BASE}/config/status" \
            "/tmp/headers_status2.txt" "/tmp/body_status2.txt" "/tmp/code_status2.txt"

      - name: Call /agent/scan
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ secrets.BDV_BASE_URL }}"

          curl -sS --fail-with-body \
            --retry 5 --retry-delay 2 --retry-all-errors \
            --connect-timeout 5 --max-time 25 \
            -D /tmp/headers_scan.txt \
            -o /tmp/body_scan.txt \
            "${BASE}/agent/scan?force_analysis=0" \
            -H "accept: application/json" \
            -H "x-bdv-secret: ${{ secrets.BDV_AGENT_SECRET }}" \
            -w "%{http_code}" > /tmp/code_scan.txt

          echo "HTTP $(cat /tmp/code_scan.txt || true)"
          echo "---- headers (scan) ----"
          head -c 2000 /tmp/headers_scan.txt || true
          echo
          echo "---- body (scan) ----"
          head -c 2000 /tmp/body_scan.txt || true
          echo

          if [[ "$(cat /tmp/code_scan.txt || true)" != "200" ]]; then
            echo "ERROR: /agent/scan returned non-200"
            exit 1
          fi

      - name: Call /monitor/tick
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ secrets.BDV_BASE_URL }}"

          curl -sS --fail-with-body \
            --retry 5 --retry-delay 2 --retry-all-errors \
            --connect-timeout 5 --max-time 25 \
            -D /tmp/headers_tick.txt \
            -o /tmp/body_tick.txt \
            "${BASE}/monitor/tick" \
            -H "accept: application/json" \
            -H "x-bdv-secret: ${{ secrets.BDV_AGENT_SECRET }}" \
            -w "%{http_code}" > /tmp/code_tick.txt

          echo "HTTP $(cat /tmp/code_tick.txt || true)"
          echo "---- headers (tick) ----"
          head -c 2000 /tmp/headers_tick.txt || true
          echo
          echo "---- body (tick) ----"
          head -c 2000 /tmp/body_tick.txt || true
          echo

          if [[ "$(cat /tmp/code_tick.txt || true)" != "200" ]]; then
            echo "ERROR: /monitor/tick returned non-200"
            exit 1
          fi
