name: BDV Cron (scan + monitor)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch: {}

jobs:
  bdv:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Ensure AUTO execution mode (and log config)
        shell: bash
        run: |
          set -euo pipefail

          echo "Checking config status..."
          STATUS="$(curl --fail-with-body -sS --retry 3 --retry-delay 2 --retry-all-errors \
            "${{ secrets.BDV_BASE_URL }}/config/status" \
            -H "accept: application/json" \
            -H "x-bdv-secret: ${{ secrets.BDV_AGENT_SECRET }}")"

          echo "$STATUS" | head -c 2000
          echo

          if echo "$STATUS" | grep -q '"execution_mode":"auto"\|"mode":"auto"'; then
            echo "Already AUTO âœ…"
          else
            echo "Setting execution_mode=auto..."
            printf '%s' '{"mode":"auto"}' | curl --fail-with-body -sS --retry 3 --retry-delay 2 --retry-all-errors \
              -X POST "${{ secrets.BDV_BASE_URL }}/config/execution-mode" \
              -H "accept: application/json" \
              -H "Content-Type: application/json" \
              -H "x-bdv-secret: ${{ secrets.BDV_AGENT_SECRET }}" \
              --data-binary @- | head -c 2000
            echo
          fi

      - name: Call /agent/scan
        shell: bash
        run: |
          set -euo pipefail
          curl --fail-with-body -sS --retry 3 --retry-delay 2 --retry-all-errors \
            "${{ secrets.BDV_BASE_URL }}/agent/scan?force_analysis=0" \
            -H "accept: application/json" \
            -H "x-bdv-secret: ${{ secrets.BDV_AGENT_SECRET }}" \
            | head -c 2000
          echo

      - name: Call /monitor/tick
        shell: bash
        run: |
          set -euo pipefail
          curl --fail-with-body -sS --retry 3 --retry-delay 2 --retry-all-errors \
            "${{ secrets.BDV_BASE_URL }}/monitor/tick" \
            -H "accept: application/json" \
            -H "x-bdv-secret: ${{ secrets.BDV_AGENT_SECRET }}" \
            | head -c 2000
          echo
