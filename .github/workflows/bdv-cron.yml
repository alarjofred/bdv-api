name: BDV Cron (scan + monitor)

on:
  schedule:
    - cron: "*/5 * * * 1-5"
  workflow_dispatch:

jobs:
  bdv:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Scan + Monitor (RTH-aware, no curl23)
        shell: bash
        run: |
          set -euo pipefail

          BASE="${{ secrets.BDV_BASE_URL }}"
          SECRET="${{ secrets.BDV_AGENT_SECRET }}"

          if [[ -z "$BASE" || -z "$SECRET" ]]; then
            echo "ERROR: Missing BDV_BASE_URL or BDV_AGENT_SECRET"
            exit 1
          fi

          # ---- RTH gate (America/New_York 09:30-16:00) ----
          export TZ="America/New_York"
          DOW="$(date +%u)"      # 1..7
          HHMM="$(date +%H%M)"   # 0000..2359

          if (( DOW > 5 )); then
            echo "Outside RTH: weekend -> exit OK"
            exit 0
          fi

          if (( 10#$HHMM < 930 || 10#$HHMM > 1600 )); then
            echo "Outside RTH: now=$HHMM NY -> exit OK"
            exit 0
          fi

          call() {
            local method="$1"
            local url="$2"
            local out="$3"

            echo "==> $method $url"
            local code
            code=$(curl -sS -L --connect-timeout 10 --max-time 20 \
              --retry 5 --retry-delay 2 --retry-all-errors \
              -X "$method" \
              -o "$out" \
              -H "accept: application/json" \
              -H "x-bdv-secret: $SECRET" \
              -w "%{http_code}" \
              "$url" || echo "000")

            echo "HTTP $code"
            echo "-- body head --"
            head -c 800 "$out" || true
            echo
            echo "$code"
          }

          # 1) status
          code="$(call GET "$BASE/config/status" /tmp/status.json)"
          [[ "$code" == "200" ]] || { echo "FAIL /config/status"; exit 1; }

          # 2) force auto via querystring (sin body)
          code="$(call POST "$BASE/config/execution-mode?mode=auto" /tmp/set_auto.json)"
          [[ "$code" == "200" ]] || { echo "FAIL /config/execution-mode"; exit 1; }

          # 3) scan
          code="$(call GET "$BASE/agent/scan?force_analysis=0" /tmp/scan.json)"
          [[ "$code" == "200" ]] || { echo "FAIL /agent/scan"; exit 1; }

          # 4) si scan dice no operable, NO fallar (exit OK)
          if grep -qi '"status"[[:space:]]*:[[:space:]]*"yellow"' /tmp/scan.json; then
            echo "Scan yellow -> exit OK"
            exit 0
          fi

          # 5) tick
          code="$(call GET "$BASE/monitor/tick" /tmp/tick.json)"
          [[ "$code" == "200" ]] || { echo "FAIL /monitor/tick"; exit 1; }

          echo "DONE OK"
