name: BDV Cron (scan + monitor)

on:
  schedule:
    # PRO: GitHub cron usa UTC. Ponemos dos ventanas (EST/EDT) y el backend decide con in_rth.
    # EST (invierno): 9:30–16:00 ET ≈ 14:30–21:00 UTC -> usamos 14-20 (cada 5 min) y gatekeeper filtra.
    - cron: "*/5 14-20 * * 1-5"
    # EDT (verano): 9:30–16:00 ET ≈ 13:30–20:00 UTC -> usamos 13-19 y gatekeeper filtra.
    - cron: "*/5 13-19 * * 1-5"
  workflow_dispatch: {}

jobs:
  bdv:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Ensure AUTO execution mode (querystring) + log config (robust)
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ secrets.BDV_BASE_URL }}"

          echo "Checking config status..."
          curl -sS --retry 5 --retry-delay 2 --retry-all-errors --connect-timeout 5 --max-time 25 \
            -D /tmp/headers_status.txt \
            -o /tmp/body_status.txt \
            "${BASE}/config/status" \
            -H "accept: application/json" \
            -H "x-bdv-secret: ${{ secrets.BDV_AGENT_SECRET }}" \
            -w "%{http_code}" > /tmp/code_status.txt

          echo "HTTP $(cat /tmp/code_status.txt || true)"
          echo "---- body (status) ----"
          head -c 2000 /tmp/body_status.txt || true
          echo

          echo "Setting execution_mode=auto via querystring..."
          curl -sS --retry 5 --retry-delay 2 --retry-all-errors --connect-timeout 5 --max-time 25 \
            -D /tmp/headers_set.txt \
            -o /tmp/body_set.txt \
            -X POST "${BASE}/config/execution-mode?mode=auto" \
            -H "accept: application/json" \
            -H "x-bdv-secret: ${{ secrets.BDV_AGENT_SECRET }}" \
            -w "%{http_code}" > /tmp/code_set.txt

          echo "HTTP $(cat /tmp/code_set.txt || true)"
          echo "---- body (set) ----"
          head -c 2000 /tmp/body_set.txt || true
          echo

      - name: Call /agent/scan (gatekeeper: DO NOT FAIL outside RTH)
        id: scan
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ secrets.BDV_BASE_URL }}"

          curl -sS --retry 5 --retry-delay 2 --retry-all-errors --connect-timeout 5 --max-time 25 \
            -o /tmp/body_scan.txt \
            "${BASE}/agent/scan?force_analysis=0" \
            -H "accept: application/json" \
            -H "x-bdv-secret: ${{ secrets.BDV_AGENT_SECRET }}" \
            -w "%{http_code}" > /tmp/code_scan.txt

          code="$(cat /tmp/code_scan.txt || true)"
          echo "HTTP ${code}"
          echo "---- body (scan) ----"
          head -c 2000 /tmp/body_scan.txt || true
          echo

          # Si no es 200, ahí sí fallamos (problema real: auth/red/etc.)
          if [[ "${code}" != "200" ]]; then
            echo "ERROR: /agent/scan returned HTTP ${code}"
            exit 1
          fi

          # Parsear in_rth sin jq
          IN_RTH="$(python -c 'import json; d=json.load(open("/tmp/body_scan.txt")); print("true" if d.get("in_rth") else "false")')"
          echo "in_rth=${IN_RTH}" >> "$GITHUB_OUTPUT"
          echo "Parsed in_rth=${IN_RTH}"

          # FUERA de RTH = SUCCESS + se salta tick
          if [[ "${IN_RTH}" != "true" ]]; then
            echo "Outside RTH -> skipping /monitor/tick (success)."
            exit 0
          fi

      - name: Call /monitor/tick (ONLY if in RTH)
        if: steps.scan.outputs.in_rth == 'true'
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ secrets.BDV_BASE_URL }}"

          curl -sS --retry 5 --retry-delay 2 --retry-all-errors --connect-timeout 5 --max-time 25 \
            -o /tmp/body_tick.txt \
            "${BASE}/monitor/tick" \
            -H "accept: application/json" \
            -H "x-bdv-secret: ${{ secrets.BDV_AGENT_SECRET }}" \
            -w "%{http_code}" > /tmp/code_tick.txt

          echo "HTTP $(cat /tmp/code_tick.txt || true)"
          echo "---- body (tick) ----"
          head -c 2000 /tmp/body_tick.txt || true
          echo

          if [[ "$(cat /tmp/code_tick.txt || true)" != "200" ]]; then
            echo "ERROR: /monitor/tick returned non-200"
            exit 1
          fi
